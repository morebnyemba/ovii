# WhatsApp Template Sync Fix - Issue g566

## Problem Summary
The `sync_whatsapp_templates` command was failing to create WhatsApp templates with:
- HTTP 400 Bad Request errors
- Error details (status_code, error_code, error_type) showing as "None"
- No detailed error message from Meta API visible
- 7 out of 14 templates failing to sync

## Root Cause Analysis

### PRIMARY ISSUE: Missing OTP Button in AUTHENTICATION Template
The `otp_verification` template was missing the required OTP button component that Meta requires for AUTHENTICATION category templates. According to Meta's WhatsApp Business API documentation, AUTHENTICATION templates **must** include an OTP button (either COPY_CODE or ONE_TAP type).

**Old Template Structure (INCORRECT)**:
```python
"otp_verification": {
    "category": "AUTHENTICATION",
    "structure": {
        "body": "Your Ovii verification code is {{1}}...",
        "footer": None,
        "buttons": []  # Empty - This was causing 400 errors!
    }
}
```

**Fixed Template Structure**:
```python
"otp_verification": {
    "category": "AUTHENTICATION",
    "structure": {
        "body": "Your Ovii verification code is {{1}}...",
        "footer": "This code is confidential",
        "buttons": [
            {
                "type": "OTP",
                "otp_type": "COPY_CODE"
                # Note: 'text' field omitted - auto-generated by Meta
            }
        ]
    }
}
```

### Issue 2: Response Object Not Captured
When `requests.raise_for_status()` raised an `HTTPError`, the response details weren't always properly captured for error display.

### Issue 3: Error Details Not Displayed
Even when error details were available in the exception, they were only shown if truthy (not None), making debugging difficult.

### Issue 4: Raw Response Not Visible
The actual Meta API error message in the response body was only logged at DEBUG level and never shown to the user, even in verbose mode.

## Changes Made

### 1. whatsapp_templates.py - Fixed OTP Template (PRIMARY FIX)

**Added required components for AUTHENTICATION templates:**
```python
"buttons": [
    {
        "type": "OTP",
        "otp_type": "COPY_CODE"
        # 'text' field omitted - auto-generated by Meta based on language
    }
],
"footer": "This code is confidential"
```

**Why this fixes the 400 errors:**
- Meta's API validates template structure before creation
- AUTHENTICATION category templates require OTP buttons
- Without the OTP button, Meta returns 400 Bad Request
- The button enhances user experience with one-tap code copying

### 2. services.py - Improved Error Handling

#### Store Response Before raise_for_status()
```python
try:
    response = requests.post(url, json=template_data, headers=headers, timeout=30)
    
    # Log response BEFORE raise_for_status() to capture error details
    logger.debug(f"Response status code: {response.status_code}")
    logger.debug(f"Response body: {response.text}")
    
    response.raise_for_status()  # Now errors will have logged response
```

#### Safe Response Object Extraction
```python
except requests.exceptions.HTTPError as e:
    # Safely extract response object
    response_obj = getattr(e, 'response', None)
    
    # Safely extract status and text
    status_code = getattr(response_obj, 'status_code', None) if response_obj else None
    response_text = None
    if response_obj:
        try:
            response_text = response_obj.text
        except Exception:
            response_text = None
```

#### Better Error Parsing with Fallbacks
```python
if response_obj and response_text:
    try:
        error_data = response_obj.json()
    except (json.JSONDecodeError, ValueError, TypeError) as json_err:
        # Fallback to raw text if JSON parsing fails
        logger.warning(f"Failed to parse error as JSON: {json_err}")
        error_data = {"error": {"message": response_text}}
elif not response_obj:
    error_data = {"error": {"message": str(e)}}
else:
    error_data = {"error": {"message": f"HTTP {status_code} with no body"}}
```

#### Multiple Error Extraction Fallbacks
```python
# Extract with multiple fallback strategies
error_obj = error_data.get("error", {})
error_message = (
    error_obj.get("message") or 
    error_obj.get("error_message") or 
    error_obj.get("error_user_msg") or
    error_data.get("message") or
    response_text[:500] or
    str(e)
)
```

### 3. sync_whatsapp_templates.py - Enhanced Error Display

#### Extract All Error Attributes
```python
# Extract all possible error attributes
status_code = getattr(api_error, 'status_code', None)
error_code = getattr(api_error, 'error_code', None)
error_type = getattr(api_error, 'error_type', None)
error_subcode = getattr(api_error, 'error_subcode', None)
error_user_title = getattr(api_error, 'error_user_title', None)
error_user_msg = getattr(api_error, 'error_user_msg', None)
fbtrace_id = getattr(api_error, 'fbtrace_id', None)
raw_response = getattr(api_error, 'raw_response', None)
response_headers = getattr(api_error, 'response_headers', None)
```

#### Always Show Key Fields (Even if None)
```python
# Always show these fields for debugging (even if None to indicate missing data)
self.stdout.write(f"    HTTP Status: {status_code}")
self.stdout.write(f"    Error Code: {error_code}")
self.stdout.write(f"    Error Type: {error_type}")
```

#### Helpful Message for Missing Details
```python
# If we got HTTP 400 with no detailed error info, show a helpful message
if status_code == 400 and not error_code and not error_type:
    self.stdout.write(
        self.style.WARNING(
            f"    ⚠ Note: Meta API returned 400 Bad Request without detailed error information.\n"
            f"       This usually indicates a payload format issue. Check the logs for details."
        )
    )
```

#### Show Response Headers in Verbose Mode
```python
# In verbose mode, show response headers
if verbose:
    if response_headers:
        self.stdout.write(self.style.WARNING(f"  Response Headers:"))
        for key, value in response_headers.items():
            self.stdout.write(f"    {key}: {value}")
```

#### Show Raw Response Immediately in Verbose Mode
```python
# In verbose mode, show raw response immediately
if verbose:
    raw_response = getattr(api_error, 'raw_response', None)
    if raw_response:
        self.stdout.write(self.style.WARNING(f"  Raw API Response:"))
        truncated_response = truncate_text(raw_response, MAX_ERROR_DISPLAY_LENGTH)
        self.stdout.write(f"    {truncated_response}")
```

### 4. tests.py - Updated for OTP Button

**Updated test to verify new template structure:**
```python
def test_convert_template_to_meta_format(self):
    result = convert_template_to_meta_format("otp_verification")
    
    # Verify AUTHENTICATION template has required components
    components = result["components"]
    
    # Check for footer
    footer = next((c for c in components if c["type"] == "FOOTER"), None)
    self.assertIsNotNone(footer)
    
    # Check for OTP button
    buttons = next((c for c in components if c["type"] == "BUTTONS"), None)
    self.assertIsNotNone(buttons)
    
    # Verify OTP button structure
    otp_button = buttons["buttons"][0]
    self.assertEqual(otp_button["type"], "OTP")
    self.assertEqual(otp_button["otp_type"], "COPY_CODE")
    self.assertNotIn("text", otp_button)  # Auto-generated by Meta
```

## Testing Instructions

### 1. Rebuild Docker Image
```bash
docker compose build backend
```

### 2. Run Sync Command with Verbose Mode
```bash
docker compose exec backend python manage.py sync_whatsapp_templates --verbose
```

### 3. What to Look For

#### Expected Output with Fixes:
```
Processing template: otp_verification
  Checking template status in Meta...
  Template does not exist in Meta, will create...
  Template payload for Meta API:
    {
      "name": "otp_verification",
      "category": "AUTHENTICATION",
      "language": "en_US",
      "components": [
        {"type": "BODY", "text": "Your Ovii verification code is {{1}}...", "example": {...}},
        {"type": "FOOTER", "text": "This code is confidential"},
        {"type": "BUTTONS", "buttons": [{"type": "OTP", "otp_type": "COPY_CODE"}]}
      ]
    }
  ✓ Template created successfully (ID: 25397606133228629)
    Status: PENDING
```

#### If Error Occurs (with improved diagnostics):
```
  ✗ Failed: Meta API error: Invalid template format
    HTTP Status: 400
    Error Code: 100
    Error Type: OAuthException
    Details: Template components are invalid
    FB Trace ID: AbcXyz123
  
  Raw API Response:
    {"error": {"message": "Invalid template format", "code": 100, ...}}
```

#### Key Improvements:
1. **Templates now have correct structure** - OTP button added to AUTHENTICATION templates
2. **HTTP Status will show actual value** (e.g., 400) instead of None
3. **Error Code will show actual value** (e.g., 100, 368, etc.) instead of None
4. **Raw API Response will be visible** showing exactly what Meta returned
5. **Detailed error message** from Meta API will be displayed
6. **Response headers** shown in verbose mode for debugging
7. **Helpful messages** when error details are missing

## Meta API Requirements for AUTHENTICATION Templates

### Required Components:
1. **BODY** - Message text with OTP placeholder (e.g., {{1}})
2. **OTP Button** - Must be one of:
   - `COPY_CODE` - Allows user to copy the code
   - `ONE_TAP` - Allows autofill on supported devices
3. **FOOTER** (Optional but recommended) - Security message

### OTP Button Format:
```json
{
  "type": "OTP",
  "otp_type": "COPY_CODE"
}
```
**Important**: The `text` field should NOT be included - it's auto-generated by Meta based on the template's language.

### Example Valid AUTHENTICATION Template:
```json
{
  "name": "otp_verification",
  "category": "AUTHENTICATION",
  "language": "en_US",
  "components": [
    {
      "type": "BODY",
      "text": "Your verification code is {{1}}. Valid for 5 minutes.",
      "example": {"body_text": [["123456"]]}
    },
    {
      "type": "FOOTER",
      "text": "This code is confidential"
    },
    {
      "type": "BUTTONS",
      "buttons": [{"type": "OTP", "otp_type": "COPY_CODE"}]
    }
  ]
}
```

## Common Meta API Error Codes

Based on the Web search and Meta documentation:

| Error Code | Description | Solution |
|-----------|-------------|----------|
| 100 | Invalid parameter | Check template format, variable count, examples |
| 368 | Temporarily blocked due to policy violation | Review template content against Meta's policies |
| 4 | Too many requests | Wait and retry, or reduce request frequency |
| 80007 | Rate limit exceeded | Spread out API calls |
| 131031 | Template name already exists | Use a different name or update existing |
| 33 | Invalid template category | Use AUTHENTICATION, MARKETING, or UTILITY |

## Next Steps

### Once We See the Actual Error:

#### Scenario 1: Invalid Parameter (Code 100)
Common causes:
- Variable count mismatch between text and examples
- Invalid characters in template name
- Missing or incorrect format in components
- Language code not supported

**Fix:** Update template definitions in `whatsapp_templates.py`

#### Scenario 2: Policy Violation (Code 368)
Common causes:
- Template contains promotional content in wrong category
- URL/link issues
- Content violates WhatsApp policies

**Fix:** Modify template content to comply with policies

#### Scenario 3: Rate Limit (Code 4 or 80007)
**Fix:** Add delays between template creation:
```python
import time
# In _sync_templates_to_meta loop
time.sleep(2)  # Wait 2 seconds between templates
```

#### Scenario 4: Duplicate Template
**Fix:** Already handled - command skips existing templates

## Monitoring and Logs

### View Full Logs
```bash
# Backend logs
docker compose logs backend -f

# Filter for WhatsApp template errors
docker compose logs backend | grep -i "whatsapp\|template"
```

### Django Debug Level Logging
Set in settings or environment:
```python
LOGGING = {
    'loggers': {
        'integrations.services': {
            'level': 'DEBUG',  # Shows all request/response details
        },
    },
}
```

## Additional Improvements Made

### 1. Better Exception Attributes
All exceptions now have structured attributes:
- `status_code`: HTTP status code
- `error_code`: Meta API error code
- `error_type`: Error type from Meta
- `error_subcode`: Sub-error code
- `error_user_msg`: User-friendly message
- `fbtrace_id`: Facebook trace ID for support
- `raw_response`: Full response text
- `full_error`: Complete error object
- `is_duplicate`: Flag for duplicate template errors

### 2. Comprehensive Logging
- All errors logged at ERROR level
- Debug details logged at DEBUG level
- Request payloads logged before sending
- Response details logged after receiving

### 3. Graceful Degradation
- If response object is unavailable, use exception message
- If JSON parsing fails, use raw response text
- If error fields are missing, show None instead of crashing

## Rollback Plan

If issues arise:
```bash
git checkout HEAD~1 -- ovii_backend/integrations/services.py
git checkout HEAD~1 -- ovii_backend/integrations/management/commands/sync_whatsapp_templates.py
docker compose build backend
docker compose restart backend
```

## Support

If errors persist:
1. Share the full verbose output showing the actual Meta API response
2. Check Meta Business Manager for template status and rejection reasons
3. Review WhatsApp Business API documentation for template requirements
4. Contact Meta support with the `fbtrace_id` from error logs

## References

- [Meta WhatsApp Business Cloud API Documentation](https://developers.facebook.com/docs/whatsapp/cloud-api/reference/messages)
- [WhatsApp Template Message Policies](https://developers.facebook.com/docs/whatsapp/message-templates/guidelines)
- [Common Error Codes](https://developers.facebook.com/docs/whatsapp/cloud-api/support/error-codes)
