# WhatsApp OTP Template Fix - Summary

## Issue Description

The WhatsApp OTP verification template was failing with two distinct errors when attempting to send OTP codes to users:

### Error 1: Template Not Found (404 - Error #132001)
```
Template name does not exist in the translation
template name (otp_verification) does not exist in en
```

**Root Cause**: The application was sending template messages with language code `"en"`, but the template in Meta was created with language code `"en_US"`. Meta's API requires exact language code matches.

### Error 2: Button Parameter Missing (400 - Error #131008)
```
Required parameter is missing
buttons: Button at index 0 of type Url requires a parameter
```

**Root Cause**: The template was manually recreated in Meta with incorrect button structure. When the BUTTONS component was explicitly included for OTP authentication templates, Meta expected URL parameters because it interpreted the button as a URL button instead of recognizing it as an OTP authentication template.

## Solution

### 1. Language Code Normalization

Created a reusable `normalize_language_code()` function that converts short language codes to Meta's expected format:

```python
def normalize_language_code(language_code: str) -> str:
    """
    Normalize language code to Meta's expected format.
    Converts short codes like 'en' to full codes like 'en_US'.
    """
    if not language_code:
        return "en_US"
    
    if "_" in language_code or "-" in language_code:
        return language_code.replace("-", "_")
    
    language_mapping = {
        "en": "en_US",
        "es": "es_ES",
        "fr": "fr_FR",
        "de": "de_DE",
        "pt": "pt_BR",
        "zh": "zh_CN",
    }
    
    return language_mapping.get(language_code.lower(), f"{language_code}_US")
```

**Applied in two places:**
1. `convert_template_to_meta_format()` - when creating templates in Meta
2. `send_template_message()` - when sending template messages

This ensures consistency between template creation and template sending.

### 2. OTP Button Structure Fix

Modified `convert_template_to_meta_format()` to NOT include the BUTTONS component for OTP authentication templates:

```python
# Check once and reuse
has_otp_button = any(
    button.get("type") == "OTP" 
    for button in structure.get("buttons", [])
)
is_otp_auth_template = template["category"] == "AUTHENTICATION" and has_otp_button

# For OTP templates, use add_security_recommendation instead of BUTTONS
if is_otp_auth_template:
    body_component["add_security_recommendation"] = True
else:
    body_component["text"] = structure["body"]

# Don't add BUTTONS component for OTP templates
if structure.get("buttons") and not is_otp_auth_template:
    components.append({"type": "BUTTONS", "buttons": structure["buttons"]})
```

**Why this works:**
- Meta's WhatsApp Business API automatically adds a "Copy code" button for AUTHENTICATION category templates when `add_security_recommendation=True` is set
- Explicitly including a BUTTONS component causes confusion and errors
- The template body text is also auto-generated by Meta for OTP templates

## Files Changed

1. **ovii_backend/integrations/whatsapp_templates.py**
   - Added `normalize_language_code()` function
   - Refactored `convert_template_to_meta_format()` to use language normalization
   - Fixed button component logic for OTP authentication templates
   - Eliminated code duplication by computing `is_otp_auth_template` once

2. **ovii_backend/integrations/services.py**
   - Updated `send_template_message()` to normalize language codes before sending
   - Added import for `normalize_language_code` function

## Testing

All manual tests passed:
- ✅ Language code `"en"` correctly converts to `"en_US"`
- ✅ Language code `"es"` correctly converts to `"es_ES"`
- ✅ Already formatted codes like `"en_US"` pass through unchanged
- ✅ Hyphenated codes like `"en-GB"` convert to `"en_GB"`
- ✅ OTP template includes `add_security_recommendation=True` in BODY component
- ✅ OTP template does NOT include BUTTONS component
- ✅ Refactored code produces identical output to original

## Code Quality

- ✅ Code review passed
- ✅ Security scan (CodeQL) found no issues
- ✅ Eliminated code duplication
- ✅ Added comprehensive comments explaining the logic
- ✅ No breaking changes to existing functionality

## Next Steps for Deployment

1. **Re-sync the OTP template to Meta** (if needed):
   ```bash
   python manage.py sync_whatsapp_templates --template otp_verification --verbose
   ```

2. **Verify template status**:
   ```bash
   python manage.py sync_whatsapp_templates --check-status --template otp_verification
   ```

3. **Test OTP sending** after template is approved:
   - Trigger OTP request through the application
   - Check Celery logs for successful template sending
   - Verify user receives OTP via WhatsApp

## Expected Outcome

After this fix:
1. Templates will be sent with the correct language code (`en_US`)
2. OTP templates will use the correct structure (no explicit BUTTONS component)
3. Users should receive OTP codes successfully via WhatsApp
4. No more 404 or 400 errors in the Celery logs
